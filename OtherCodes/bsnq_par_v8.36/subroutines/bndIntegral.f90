subroutine bndIntegral(npoinl,npoint,nelem,nbnd,conn,mabnd,invJ,&
	depth,bndSide,bndNormal,eta,w,p,q,gFp,gFq,gFn,gFw,cnst)
implicit none

  integer(kind=4),intent(in)::npoinl,npoint,nelem,nbnd
  integer(kind=4),intent(in)::conn(nelem,6),mabnd(nbnd,6)
  integer(kind=4)::i,j,k,ele,sn(3),en(6)

  real(kind=8),intent(in)::bndSide(nbnd,3),bndNormal(npoint,2)
  real(kind=8),intent(in)::eta(npoinl),w(npoinl),depth(npoint)
  real(kind=8),intent(in)::cnst(10),invJ(nelem,5)
  real(kind=8),intent(in)::p(npoint),q(npoint)
  real(kind=8),intent(out)::gFp(npoint),gFq(npoint)
  real(kind=8),intent(out)::gFn(npoinl),gFw(npoinl)
  real(kind=8)::nx(3),ny(3),lw(3),leta(3),lh(3)
  real(kind=8)::lFp(6),lFq(6),lFn(3),lFw(3),lp(6),lq(6)
  real(kind=8)::b11,b12,b21,b22

  gFp=0
  gFq=0
  gFn=0
  gFw=0

  do i=1,nbnd
    sn(1)=mabnd(i,1)
    sn(2)=mabnd(i,2)
    sn(3)=mabnd(i,5)
    ele=mabnd(i,3)
    en=conn(ele,:)

    do j=1,3
      nx(j)=bndNormal(sn(j),1)
      ny(j)=bndNormal(sn(j),2)
    enddo

    do j=1,6
      lp(j)=p(en(j))
      lq(j)=q(en(j))
    enddo

    do j=1,3
      lw(j)=w(en(j))
      leta(j)=eta(en(j))
      lh(j)=depth(en(j))
    enddo

    b11=invJ(ele,1)
    b12=invJ(ele,2)
    b21=invJ(ele,3)
    b22=invJ(ele,4)

    if(mabnd(i,6).eq.1) then
      call boundaryCase12(lFp,lFq,lFn,lFw,nx,ny,lp,lq,lw,&
        leta,lh,cnst,b11,b12,b21,b22)
    else if(mabnd(i,6).eq.2) then
      call boundaryCase23(lFp,lFq,lFn,lFw,nx,ny,lp,lq,lw,&
        leta,lh,cnst,b11,b12,b21,b22)
    else if(mabnd(i,6).eq.3) then
      call boundaryCase31(lFp,lFq,lFn,lFw,nx,ny,lp,lq,lw,&
        leta,lh,cnst,b11,b12,b21,b22)
    else
      write(9,*)"[Err] Boundary side not 1, 2 or 3 for bnd",i
      stop
    endif

    lFp=lFp*bndSide(i,3)
    lFq=lFq*bndSide(i,3)
    !lFn=lFn*bndSide(i,3)
    lFw=lFw*bndSide(i,3)

    do j=1,6
      gFp(en(j))=gFp(en(j))+lFp(j)
      gFq(en(j))=gFq(en(j))+lFq(j)
    enddo

    do j=1,3
      gFw(en(j))=gFw(en(j))+lFw(j)
      gFn(en(j))=gFn(en(j))+lFn(j)
    enddo

  enddo

end subroutine bndIntegral

subroutine boundaryCase12(fp,fq,fn,fw,nx,ny,p,q,w,&
  n,h,cnst,b11,b12,b21,b22)
implicit none
  
  integer(kind=4)::i,j,k

  real(kind=8),intent(in)::nx(3),ny(3),p(6),q(6),h(3)
  real(kind=8),intent(in)::w(3),n(3),cnst(10)
  real(kind=8),intent(in)::b11,b12,b21,b22
  real(kind=8),intent(out)::fp(6),fq(6),fn(3),fw(3)
  real(kind=8)::tfp(6),tfq(6)

  fp=0
  fq=0
  fn=0
  fw=0
  tfp=0
  tfq=0

  !! Fn
  ! fn(1)=(7d0*nx(1)*p(1))/60d0 - (nx(2)*p(1))/60d0 &
  !   + (nx(3)*p(1))/15d0 - (nx(1)*p(2))/60d0 + (nx(2)*p(2))/60d0 &
  !   + (nx(1)*p(4))/15d0 + (4d0*nx(3)*p(4))/15d0 &
  !   + (7*ny(1)*q(1))/60 - (ny(2)*q(1))/60 + (ny(3)*q(1))/15 &
  !   - (ny(1)*q(2))/60 + (ny(2)*q(2))/60 + (ny(1)*q(4))/15 &
  !   + (4*ny(3)*q(4))/15

  ! fn(2)=(nx(1)*p(1))/60 - (nx(2)*p(1))/60 - (nx(1)*p(2))/60 &
  !   + (7*nx(2)*p(2))/60 + (nx(3)*p(2))/15 + (nx(2)*p(4))/15 &
  !   + (4*nx(3)*p(4))/15 + (ny(1)*q(1))/60 - (ny(2)*q(1))/60 &
  !   - (ny(1)*q(2))/60 + (7*ny(2)*q(2))/60 + (ny(3)*q(2))/15 &
  !   + (ny(2)*q(4))/15 + (4*ny(3)*q(4))/15

  ! fn=-fn


  !! Fw
  fw(1)=(1d0/60d0)*((-(b11*(n(1) - n(2)) &
    + b12*(n(1) - n(3))))*(h(2)*(nx(1) + nx(2) + 8*nx(3)) &
    + h(1)*(9*nx(1) - nx(2) + 12*nx(3))) &
    - (b21*(n(1) - n(2)) + b22*(n(1) - n(3)))*(h(2)*(ny(1) &
    + ny(2) + 8*ny(3)) + h(1)*(9*ny(1) - ny(2) + 12*ny(3))))

  fw(2)=(1d0/60d0)*((-(b11*(n(1) - n(2)) &
    + b12*(n(1) - n(3))))*(h(1)*(nx(1) + nx(2) + 8*nx(3)) &
    + h(2)*(-nx(1) + 9*nx(2) + 12*nx(3))) &
    - (b21*(n(1) - n(2)) + b22*(n(1) - n(3)))*(h(1)*(ny(1) &
    + ny(2) + 8*ny(3)) + h(2)*(-ny(1) + 9*ny(2) + 12*ny(3))))


  !! Fpt1
  tfp(1)=(1d0/420d0)*((-b11)*(2*h(1)*h(2)*(2*(nx(2)*(-p(1) &
    + p(2)) + 2*nx(3)*(3*p(1) + p(2) - 4*p(4))) + nx(1)*(11*p(1) &
    + p(2) - 12*p(4))) + h(1)**2*(4*nx(1)*(29*p(1) + 7*p(2) &
    - 36*p(4)) - nx(2)*(11*p(1) + p(2) - 12*p(4)) &
    + 8*nx(3)*(7*p(1) + p(2) - 8*p(4))) + h(2)**2*(2*nx(1)*(p(1) &
    - p(2)) + nx(2)*(p(1) + 11*p(2) - 12*p(4)) + 4*nx(3)*(p(1) &
    + 3*p(2) - 4*p(4)))) - b12*(2*h(1)*h(2)*(-2*(-2*nx(3)*(3*p(1) &
    + p(3) - 4*p(6)) + nx(2)*(p(1) + p(3) + 2*p(4) - 2*p(5) &
    - 2*p(6))) + nx(1)*(11*p(1) + 5*p(3) + 4*p(4) - 4*p(5) &
    - 16*p(6))) + h(1)**2*(4*nx(1)*(29*p(1) + 11*p(3) &
    + 4*p(4) - 4*p(5) - 40*p(6)) + 8*nx(3)*(7*p(1) &
    + 3*p(3) + 2*p(4) - 2*p(5) - 10*p(6)) + nx(2)*(-11*p(1) &
    - 5*p(3) - 4*p(4) + 4*p(5) + 16*p(6))) &
    + h(2)**2*(4*nx(3)*(p(1) - p(3) - 4*p(4) + 4*p(5)) &
    + 2*nx(1)*(p(1) + p(3) + 2*p(4) - 2*p(5) - 2*p(6)) &
    + nx(2)*(p(1) - 5*p(3) + 4*(-4*p(4) + 4*p(5) + p(6))))))

  tfp(2)=(1d0/420d0)*(b11*(h(1)**2*(2*(nx(2)*(-p(1) + p(2)) &
    + 2*nx(3)*(3*p(1) + p(2) - 4*p(4))) + nx(1)*(11*p(1) &
    + p(2) - 12*p(4))) + h(2)**2*(4*(nx(2)*(7*p(1) + 29*p(2) &
    - 36*p(4)) + 2*nx(3)*(p(1) + 7*p(2) - 8*p(4))) &
    - nx(1)*(p(1) + 11*p(2) - 12*p(4))) &
    + 2*h(1)*h(2)*(2*nx(1)*(p(1) - p(2)) + nx(2)*(p(1) &
    + 11*p(2) - 12*p(4)) + 4*nx(3)*(p(1) + 3*p(2) - 4*p(4)))) &
    + b12*(h(1)**2*(-2*(-2*nx(3)*(3*p(1) + p(3) - 4*p(6)) &
    + nx(2)*(p(1) + p(3) + 2*p(4) - 2*p(5) - 2*p(6))) &
    + nx(1)*(11*p(1) + 5*p(3) + 4*p(4) - 4*p(5) - 16*p(6))) &
    + 2*h(1)*h(2)*(4*nx(3)*(p(1) - p(3) - 4*p(4) + 4*p(5)) &
    + 2*nx(1)*(p(1) + p(3) + 2*p(4) - 2*p(5) - 2*p(6)) &
    + nx(2)*(p(1) - 5*p(3) + 4*(-4*p(4) + 4*p(5) + p(6)))) &
    + h(2)**2*((-nx(1))*(p(1) - 5*p(3) + 4*(-4*p(4) &
    + 4*p(5) + p(6))) + 4*(nx(2)*(7*p(1) - 11*p(3) &
    - 40*p(4) + 40*p(5) + 4*p(6)) + 2*nx(3)*(p(1) - 3*p(3) &
    + 2*(-5*p(4) + 5*p(5) + p(6)))))))

  tfp(4)=(1d0/105d0)*(b11*(2*h(1)*h(2)*(12*nx(3)*(-p(1) &
    + p(2)) - nx(1)*(3*p(1) + p(2) - 4*p(4)) &
    + nx(2)*(p(1) + 3*p(2) - 4*p(4))) &
    + h(1)**2*(-2*nx(1)*(7*p(1) + p(2) - 8*p(4)) &
    + nx(2)*(3*p(1) + p(2) - 4*p(4)) + 8*nx(3)*(-3*p(1) &
    + p(2) + 2*p(4))) - h(2)**2*(nx(1)*(p(1) + 3*p(2) - 4*p(4)) &
    - 2*(nx(2)*(p(1) + 7*p(2) - 8*p(4)) - 4*nx(3)*(p(1) &
    - 3*p(2) + 2*p(4))))) - b12*(h(1)**2*(2*nx(1)*(7*p(1) &
    + 3*p(3) + 2*p(4) - 2*p(5) - 10*p(6)) + 8*nx(3)*(3*p(1) &
    + 2*p(3) + 3*p(4) - 3*p(5) - 5*p(6)) - nx(2)*(3*p(1) &
    + p(3) - 4*p(6))) + 2*h(1)*h(2)*(nx(2)*(-p(1) + p(3) &
    + 4*p(4) - 4*p(5)) + nx(1)*(3*p(1) + p(3) - 4*p(6)) &
    + 12*nx(3)*(p(1) + p(3) + 2*p(4) - 2*p(5) - 2*p(6))) &
    + h(2)**2*(nx(1)*(p(1) - p(3) - 4*p(4) + 4*p(5)) &
    + 8*nx(3)*(p(1) + 2*p(3) + 5*p(4) - 5*p(5) - 3*p(6)) &
    - 2*nx(2)*(p(1) - 3*p(3) + 2*(-5*p(4) + 5*p(5) + p(6)))))) 

  fp=fp+cnst(3)*tfp

  !! Fpt2
  tfp(1)=(1d0/420d0)*((-b21)*(2*h(1)*h(2)*(2*(nx(2)*(-q(1) &
    + q(2)) + 2*nx(3)*(3*q(1) + q(2) - 4*q(4))) + nx(1)*(11*q(1) &
    + q(2) - 12*q(4))) + h(1)**2*(4*nx(1)*(29*q(1) + 7*q(2) &
    - 36*q(4)) - nx(2)*(11*q(1) + q(2) - 12*q(4)) &
    + 8*nx(3)*(7*q(1) + q(2) - 8*q(4))) &
    + h(2)**2*(2*nx(1)*(q(1) - q(2)) + nx(2)*(q(1) + 11*q(2) &
    - 12*q(4)) + 4*nx(3)*(q(1) + 3*q(2) - 4*q(4)))) &
    - b22*(2*h(1)*h(2)*(-2*(-2*nx(3)*(3*q(1) + q(3) - 4*q(6)) &
    + nx(2)*(q(1) + q(3) + 2*q(4) - 2*q(5) - 2*q(6))) &
    + nx(1)*(11*q(1) + 5*q(3) + 4*q(4) - 4*q(5) - 16*q(6))) &
    + h(1)**2*(4*nx(1)*(29*q(1) + 11*q(3) + 4*q(4) - 4*q(5) &
    - 40*q(6)) + 8*nx(3)*(7*q(1) + 3*q(3) + 2*q(4) - 2*q(5) &
    - 10*q(6)) + nx(2)*(-11*q(1) - 5*q(3) - 4*q(4) + 4*q(5) &
    + 16*q(6))) + h(2)**2*(4*nx(3)*(q(1) - q(3) - 4*q(4) &
    + 4*q(5)) + 2*nx(1)*(q(1) + q(3) + 2*q(4) - 2*q(5) &
    - 2*q(6)) + nx(2)*(q(1) - 5*q(3) &
    + 4*(-4*q(4) + 4*q(5) + q(6))))))

  tfp(2)=(1d0/420d0)*(b21*(h(1)**2*(2*(nx(2)*(-q(1) + q(2)) &
    + 2*nx(3)*(3*q(1) + q(2) - 4*q(4))) + nx(1)*(11*q(1) &
    + q(2) - 12*q(4))) + h(2)**2*(4*(nx(2)*(7*q(1) + 29*q(2) &
    - 36*q(4)) + 2*nx(3)*(q(1) + 7*q(2) - 8*q(4))) &
    - nx(1)*(q(1) + 11*q(2) - 12*q(4))) &
    + 2*h(1)*h(2)*(2*nx(1)*(q(1) - q(2)) + nx(2)*(q(1) &
    + 11*q(2) - 12*q(4)) + 4*nx(3)*(q(1) + 3*q(2) - 4*q(4)))) &
    + b22*(h(1)**2*(-2*(-2*nx(3)*(3*q(1) + q(3) - 4*q(6)) &
    + nx(2)*(q(1) + q(3) + 2*q(4) - 2*q(5) - 2*q(6))) &
    + nx(1)*(11*q(1) + 5*q(3) + 4*q(4) - 4*q(5) - 16*q(6))) &
    + 2*h(1)*h(2)*(4*nx(3)*(q(1) - q(3) - 4*q(4) + 4*q(5)) &
    + 2*nx(1)*(q(1) + q(3) + 2*q(4) - 2*q(5) - 2*q(6)) &
    + nx(2)*(q(1) - 5*q(3) + 4*(-4*q(4) + 4*q(5) + q(6)))) &
    + h(2)**2*((-nx(1))*(q(1) - 5*q(3) + 4*(-4*q(4) &
    + 4*q(5) + q(6))) + 4*(nx(2)*(7*q(1) - 11*q(3) &
    - 40*q(4) + 40*q(5) + 4*q(6)) + 2*nx(3)*(q(1) - 3*q(3) &
    + 2*(-5*q(4) + 5*q(5) + q(6)))))))

  tfp(4)=(1d0/105d0)*(b21*(2*h(1)*h(2)*(12*nx(3)*(-q(1) &
    + q(2)) - nx(1)*(3*q(1) + q(2) - 4*q(4)) + nx(2)*(q(1) &
    + 3*q(2) - 4*q(4))) + h(1)**2*(-2*nx(1)*(7*q(1) + q(2) &
    - 8*q(4)) + nx(2)*(3*q(1) + q(2) - 4*q(4)) &
    + 8*nx(3)*(-3*q(1) + q(2) + 2*q(4))) &
    - h(2)**2*(nx(1)*(q(1) + 3*q(2) - 4*q(4)) &
    - 2*(nx(2)*(q(1) + 7*q(2) - 8*q(4)) - 4*nx(3)*(q(1) &
    - 3*q(2) + 2*q(4))))) - b22*(h(1)**2*(2*nx(1)*(7*q(1) &
    + 3*q(3) + 2*q(4) - 2*q(5) - 10*q(6)) + 8*nx(3)*(3*q(1) &
    + 2*q(3) + 3*q(4) - 3*q(5) - 5*q(6)) - nx(2)*(3*q(1) &
    + q(3) - 4*q(6))) + 2*h(1)*h(2)*(nx(2)*(-q(1) + q(3) &
    + 4*q(4) - 4*q(5)) + nx(1)*(3*q(1) + q(3) - 4*q(6)) &
    + 12*nx(3)*(q(1) + q(3) + 2*q(4) - 2*q(5) - 2*q(6))) &
    + h(2)**2*(nx(1)*(q(1) - q(3) - 4*q(4) + 4*q(5)) &
    + 8*nx(3)*(q(1) + 2*q(3) + 5*q(4) - 5*q(5) - 3*q(6)) &
    - 2*nx(2)*(q(1) - 3*q(3) + 2*(-5*q(4) + 5*q(5) + q(6)))))) 

  fp=fp+cnst(3)*tfp

  !! Fpt3
  tfp(1)=(1d0/420d0)*(2*h(1)*h(2)*(4*nx(3)*w(1) - nx(2)*(w(1) &
    + w(2)) + nx(1)*(4*w(1) + w(2))) &
    + h(1)**2*((-nx(2))*(4*w(1) + w(2)) + 4*nx(3)*(5*w(1) &
    + w(2)) + 4*nx(1)*(10*w(1) + w(2))) &
    + h(2)**2*(-4*nx(3)*w(2) + nx(1)*(w(1) + w(2)) &
    - nx(2)*(w(1) + 4*w(2))))

  tfp(2)=(1d0/420d0)*(2*h(1)*h(2)*(nx(2)*w(1) + 4*(nx(2) &
    + nx(3))*w(2) - nx(1)*(w(1) + w(2))) &
    + h(1)**2*(-4*nx(3)*w(1) + nx(2)*(w(1) + w(2)) &
    - nx(1)*(4*w(1) + w(2))) + h(2)**2*(4*(nx(2) + nx(3))*w(1) &
    + 20*(2*nx(2) + nx(3))*w(2) - nx(1)*(w(1) + 4*w(2))))

  tfp(4)=(1d0/105d0)*(2*h(1)*h(2)*(nx(1)*w(1) + nx(2)*w(2) &
    + 6*nx(3)*(w(1) + w(2))) + h(1)**2*((-nx(2))*w(1) &
    + 10*nx(3)*w(1) + 6*nx(3)*w(2) + nx(1)*(5*w(1) + w(2))) &
    + h(2)**2*(6*nx(3)*w(1) - nx(1)*w(2) + 10*nx(3)*w(2) &
    + nx(2)*(w(1) + 5*w(2))))

  fp=fp+cnst(6)*tfp

  !! Fqt1
  tfq(1)=(1d0/420d0)*((-b11)*(2*h(1)*h(2)*(2*(ny(2)*(-p(1) &
    + p(2)) + 2*ny(3)*(3*p(1) + p(2) - 4*p(4))) + ny(1)*(11*p(1) &
    + p(2) - 12*p(4))) + h(1)**2*(4*ny(1)*(29*p(1) + 7*p(2) &
    - 36*p(4)) - ny(2)*(11*p(1) + p(2) - 12*p(4)) &
    + 8*ny(3)*(7*p(1) + p(2) - 8*p(4))) + h(2)**2*(2*ny(1)*(p(1) &
    - p(2)) + ny(2)*(p(1) + 11*p(2) - 12*p(4)) + 4*ny(3)*(p(1) &
    + 3*p(2) - 4*p(4)))) - b12*(2*h(1)*h(2)*(-2*(-2*ny(3)*(3*p(1) &
    + p(3) - 4*p(6)) + ny(2)*(p(1) + p(3) + 2*p(4) - 2*p(5) &
    - 2*p(6))) + ny(1)*(11*p(1) + 5*p(3) + 4*p(4) - 4*p(5) &
    - 16*p(6))) + h(1)**2*(4*ny(1)*(29*p(1) + 11*p(3) &
    + 4*p(4) - 4*p(5) - 40*p(6)) + 8*ny(3)*(7*p(1) &
    + 3*p(3) + 2*p(4) - 2*p(5) - 10*p(6)) + ny(2)*(-11*p(1) &
    - 5*p(3) - 4*p(4) + 4*p(5) + 16*p(6))) &
    + h(2)**2*(4*ny(3)*(p(1) - p(3) - 4*p(4) + 4*p(5)) &
    + 2*ny(1)*(p(1) + p(3) + 2*p(4) - 2*p(5) - 2*p(6)) &
    + ny(2)*(p(1) - 5*p(3) + 4*(-4*p(4) + 4*p(5) + p(6))))))

  tfq(2)=(1d0/420d0)*(b11*(h(1)**2*(2*(ny(2)*(-p(1) + p(2)) &
    + 2*ny(3)*(3*p(1) + p(2) - 4*p(4))) + ny(1)*(11*p(1) &
    + p(2) - 12*p(4))) + h(2)**2*(4*(ny(2)*(7*p(1) + 29*p(2) &
    - 36*p(4)) + 2*ny(3)*(p(1) + 7*p(2) - 8*p(4))) &
    - ny(1)*(p(1) + 11*p(2) - 12*p(4))) &
    + 2*h(1)*h(2)*(2*ny(1)*(p(1) - p(2)) + ny(2)*(p(1) &
    + 11*p(2) - 12*p(4)) + 4*ny(3)*(p(1) + 3*p(2) - 4*p(4)))) &
    + b12*(h(1)**2*(-2*(-2*ny(3)*(3*p(1) + p(3) - 4*p(6)) &
    + ny(2)*(p(1) + p(3) + 2*p(4) - 2*p(5) - 2*p(6))) &
    + ny(1)*(11*p(1) + 5*p(3) + 4*p(4) - 4*p(5) - 16*p(6))) &
    + 2*h(1)*h(2)*(4*ny(3)*(p(1) - p(3) - 4*p(4) + 4*p(5)) &
    + 2*ny(1)*(p(1) + p(3) + 2*p(4) - 2*p(5) - 2*p(6)) &
    + ny(2)*(p(1) - 5*p(3) + 4*(-4*p(4) + 4*p(5) + p(6)))) &
    + h(2)**2*((-ny(1))*(p(1) - 5*p(3) + 4*(-4*p(4) &
    + 4*p(5) + p(6))) + 4*(ny(2)*(7*p(1) - 11*p(3) &
    - 40*p(4) + 40*p(5) + 4*p(6)) + 2*ny(3)*(p(1) - 3*p(3) &
    + 2*(-5*p(4) + 5*p(5) + p(6)))))))

  tfq(4)=(1d0/105d0)*(b11*(2*h(1)*h(2)*(12*ny(3)*(-p(1) &
    + p(2)) - ny(1)*(3*p(1) + p(2) - 4*p(4)) &
    + ny(2)*(p(1) + 3*p(2) - 4*p(4))) &
    + h(1)**2*(-2*ny(1)*(7*p(1) + p(2) - 8*p(4)) &
    + ny(2)*(3*p(1) + p(2) - 4*p(4)) + 8*ny(3)*(-3*p(1) &
    + p(2) + 2*p(4))) - h(2)**2*(ny(1)*(p(1) + 3*p(2) - 4*p(4)) &
    - 2*(ny(2)*(p(1) + 7*p(2) - 8*p(4)) - 4*ny(3)*(p(1) &
    - 3*p(2) + 2*p(4))))) - b12*(h(1)**2*(2*ny(1)*(7*p(1) &
    + 3*p(3) + 2*p(4) - 2*p(5) - 10*p(6)) + 8*ny(3)*(3*p(1) &
    + 2*p(3) + 3*p(4) - 3*p(5) - 5*p(6)) - ny(2)*(3*p(1) &
    + p(3) - 4*p(6))) + 2*h(1)*h(2)*(ny(2)*(-p(1) + p(3) &
    + 4*p(4) - 4*p(5)) + ny(1)*(3*p(1) + p(3) - 4*p(6)) &
    + 12*ny(3)*(p(1) + p(3) + 2*p(4) - 2*p(5) - 2*p(6))) &
    + h(2)**2*(ny(1)*(p(1) - p(3) - 4*p(4) + 4*p(5)) &
    + 8*ny(3)*(p(1) + 2*p(3) + 5*p(4) - 5*p(5) - 3*p(6)) &
    - 2*ny(2)*(p(1) - 3*p(3) + 2*(-5*p(4) + 5*p(5) + p(6)))))) 

  fq=fq+cnst(3)*tfq

  !! Fqt2
  tfq(1)=(1d0/420d0)*((-b21)*(2*h(1)*h(2)*(2*(ny(2)*(-q(1) + q(2)) &
    + 2*ny(3)*(3*q(1) + q(2) - 4*q(4))) + ny(1)*(11*q(1) &
    + q(2) - 12*q(4))) + h(1)**2*(4*ny(1)*(29*q(1) + 7*q(2) &
    - 36*q(4)) - ny(2)*(11*q(1) + q(2) - 12*q(4)) &
    + 8*ny(3)*(7*q(1) + q(2) - 8*q(4))) &
    + h(2)**2*(2*ny(1)*(q(1) - q(2)) + ny(2)*(q(1) + 11*q(2) &
    - 12*q(4)) + 4*ny(3)*(q(1) + 3*q(2) - 4*q(4)))) &
    - b22*(2*h(1)*h(2)*(-2*(-2*ny(3)*(3*q(1) + q(3) - 4*q(6)) &
    + ny(2)*(q(1) + q(3) + 2*q(4) - 2*q(5) - 2*q(6))) &
    + ny(1)*(11*q(1) + 5*q(3) + 4*q(4) - 4*q(5) - 16*q(6))) &
    + h(1)**2*(4*ny(1)*(29*q(1) + 11*q(3) + 4*q(4) - 4*q(5) &
    - 40*q(6)) + 8*ny(3)*(7*q(1) + 3*q(3) + 2*q(4) - 2*q(5) &
    - 10*q(6)) + ny(2)*(-11*q(1) - 5*q(3) - 4*q(4) + 4*q(5) &
    + 16*q(6))) + h(2)**2*(4*ny(3)*(q(1) - q(3) - 4*q(4) &
    + 4*q(5)) + 2*ny(1)*(q(1) + q(3) + 2*q(4) - 2*q(5) &
    - 2*q(6)) + ny(2)*(q(1) - 5*q(3) &
    + 4*(-4*q(4) + 4*q(5) + q(6))))))

  tfq(2)=(1d0/420d0)*(b21*(h(1)**2*(2*(ny(2)*(-q(1) + q(2)) &
    + 2*ny(3)*(3*q(1) + q(2) - 4*q(4))) + ny(1)*(11*q(1) &
    + q(2) - 12*q(4))) + h(2)**2*(4*(ny(2)*(7*q(1) + 29*q(2) &
    - 36*q(4)) + 2*ny(3)*(q(1) + 7*q(2) - 8*q(4))) &
    - ny(1)*(q(1) + 11*q(2) - 12*q(4))) &
    + 2*h(1)*h(2)*(2*ny(1)*(q(1) - q(2)) + ny(2)*(q(1) &
    + 11*q(2) - 12*q(4)) + 4*ny(3)*(q(1) + 3*q(2) - 4*q(4)))) &
    + b22*(h(1)**2*(-2*(-2*ny(3)*(3*q(1) + q(3) - 4*q(6)) &
    + ny(2)*(q(1) + q(3) + 2*q(4) - 2*q(5) - 2*q(6))) &
    + ny(1)*(11*q(1) + 5*q(3) + 4*q(4) - 4*q(5) - 16*q(6))) &
    + 2*h(1)*h(2)*(4*ny(3)*(q(1) - q(3) - 4*q(4) + 4*q(5)) &
    + 2*ny(1)*(q(1) + q(3) + 2*q(4) - 2*q(5) - 2*q(6)) &
    + ny(2)*(q(1) - 5*q(3) + 4*(-4*q(4) + 4*q(5) + q(6)))) &
    + h(2)**2*((-ny(1))*(q(1) - 5*q(3) + 4*(-4*q(4) &
    + 4*q(5) + q(6))) + 4*(ny(2)*(7*q(1) - 11*q(3) &
    - 40*q(4) + 40*q(5) + 4*q(6)) + 2*ny(3)*(q(1) - 3*q(3) &
    + 2*(-5*q(4) + 5*q(5) + q(6)))))))

  tfq(4)=(1d0/105d0)*(b21*(2*h(1)*h(2)*(12*ny(3)*(-q(1) &
    + q(2)) - ny(1)*(3*q(1) + q(2) - 4*q(4)) + ny(2)*(q(1) &
    + 3*q(2) - 4*q(4))) + h(1)**2*(-2*ny(1)*(7*q(1) + q(2) &
    - 8*q(4)) + ny(2)*(3*q(1) + q(2) - 4*q(4)) &
    + 8*ny(3)*(-3*q(1) + q(2) + 2*q(4))) &
    - h(2)**2*(ny(1)*(q(1) + 3*q(2) - 4*q(4)) &
    - 2*(ny(2)*(q(1) + 7*q(2) - 8*q(4)) - 4*ny(3)*(q(1) &
    - 3*q(2) + 2*q(4))))) - b22*(h(1)**2*(2*ny(1)*(7*q(1) &
    + 3*q(3) + 2*q(4) - 2*q(5) - 10*q(6)) + 8*ny(3)*(3*q(1) &
    + 2*q(3) + 3*q(4) - 3*q(5) - 5*q(6)) - ny(2)*(3*q(1) &
    + q(3) - 4*q(6))) + 2*h(1)*h(2)*(ny(2)*(-q(1) + q(3) &
    + 4*q(4) - 4*q(5)) + ny(1)*(3*q(1) + q(3) - 4*q(6)) &
    + 12*ny(3)*(q(1) + q(3) + 2*q(4) - 2*q(5) - 2*q(6))) &
    + h(2)**2*(ny(1)*(q(1) - q(3) - 4*q(4) + 4*q(5)) &
    + 8*ny(3)*(q(1) + 2*q(3) + 5*q(4) - 5*q(5) - 3*q(6)) &
    - 2*ny(2)*(q(1) - 3*q(3) + 2*(-5*q(4) + 5*q(5) + q(6)))))) 

  fq=fq+cnst(3)*tfq

  !! Fqt3
  tfq(1)=(1d0/420d0)*(2*h(1)*h(2)*(4*ny(3)*w(1) - ny(2)*(w(1) &
    + w(2)) + ny(1)*(4*w(1) + w(2))) &
    + h(1)**2*((-ny(2))*(4*w(1) + w(2)) + 4*ny(3)*(5*w(1) &
    + w(2)) + 4*ny(1)*(10*w(1) + w(2))) &
    + h(2)**2*(-4*ny(3)*w(2) + ny(1)*(w(1) + w(2)) &
    - ny(2)*(w(1) + 4*w(2))))

  tfq(2)=(1d0/420d0)*(2*h(1)*h(2)*(ny(2)*w(1) + 4*(ny(2) &
    + ny(3))*w(2) - ny(1)*(w(1) + w(2))) &
    + h(1)**2*(-4*ny(3)*w(1) + ny(2)*(w(1) + w(2)) &
    - ny(1)*(4*w(1) + w(2))) + h(2)**2*(4*(ny(2) + ny(3))*w(1) &
    + 20*(2*ny(2) + ny(3))*w(2) - ny(1)*(w(1) + 4*w(2))))

  tfq(4)=(1d0/105d0)*(2*h(1)*h(2)*(ny(1)*w(1) + ny(2)*w(2) &
    + 6*ny(3)*(w(1) + w(2))) + h(1)**2*((-ny(2))*w(1) &
    + 10*ny(3)*w(1) + 6*ny(3)*w(2) + ny(1)*(5*w(1) + w(2))) &
    + h(2)**2*(6*ny(3)*w(1) - ny(1)*w(2) + 10*ny(3)*w(2) &
    + ny(2)*(w(1) + 5*w(2))))

  fq=fq+cnst(6)*tfq

end subroutine

subroutine boundaryCase23(fp,fq,fn,fw,nx,ny,p,q,w,&
  n,h,cnst,b11,b12,b21,b22)
implicit none
  
  integer(kind=4)::i,j,k

  real(kind=8),intent(in)::nx(3),ny(3),p(6),q(6),h(3)
  real(kind=8),intent(in)::w(3),n(3),cnst(10)
  real(kind=8),intent(in)::b11,b12,b21,b22
  real(kind=8),intent(out)::fp(6),fq(6),fn(3),fw(3)
  real(kind=8)::tfp(6),tfq(6)

  fp=0
  fq=0
  fn=0
  fw=0
  tfp=0
  tfq=0

  !! Fn
  ! fn(2)=(7*nx(1)*p(2))/60 - (nx(2)*p(2))/60 &
  !   + (nx(3)*p(2))/15 - (nx(1)*p(3))/60 + (nx(2)*p(3))/60 &
  !   + (nx(1)*p(5))/15 + (4*nx(3)*p(5))/15 + (7*ny(1)*q(2))/60 &
  !   - (ny(2)*q(2))/60 + (ny(3)*q(2))/15 - (ny(1)*q(3))/60 &
  !   + (ny(2)*q(3))/60 + (ny(1)*q(5))/15 + (4*ny(3)*q(5))/15 

  ! fn(3)=(nx(1)*p(2))/60 - (nx(2)*p(2))/60 - (nx(1)*p(3))/60 &
  !   + (7*nx(2)*p(3))/60 + (nx(3)*p(3))/15 + (nx(2)*p(5))/15 &
  !   + (4*nx(3)*p(5))/15 + (ny(1)*q(2))/60 - (ny(2)*q(2))/60 &
  !   - (ny(1)*q(3))/60 + (7*ny(2)*q(3))/60 + (ny(3)*q(3))/15 &
  !   + (ny(2)*q(5))/15 + (4*ny(3)*q(5))/15

  ! fn=-fn


  !! Fw
  fw(2)=(1d0/60d0)*((-b11)*(n(1) - n(2))*(h(3)*(nx(1) + nx(2) &
    + 8*nx(3)) + h(2)*(9*nx(1) - nx(2) + 12*nx(3))) &
    - b12*(n(1) - n(3))*(h(3)*(nx(1) + nx(2) + 8*nx(3)) &
    + h(2)*(9*nx(1) - nx(2) + 12*nx(3))) - (b21*(n(1) - n(2)) &
    + b22*(n(1) - n(3)))*(h(3)*(ny(1) + ny(2) + 8*ny(3)) &
    + h(2)*(9*ny(1) - ny(2) + 12*ny(3))))

  fw(3)=(1d0/60d0)*((-b11)*(n(1) - n(2))*(h(2)*(nx(1) + nx(2) &
    + 8*nx(3)) + h(3)*(-nx(1) + 9*nx(2) + 12*nx(3))) &
    - b12*(n(1) - n(3))*(h(2)*(nx(1) + nx(2) + 8*nx(3)) &
    + h(3)*(-nx(1) + 9*nx(2) + 12*nx(3))) - (b21*(n(1) - n(2)) &
    + b22*(n(1) - n(3)))*(h(2)*(ny(1) + ny(2) + 8*ny(3)) &
    + h(3)*(-ny(1) + 9*ny(2) + 12*ny(3))))


  !! Fpt1
  tfp(2)=(1d0/420d0)*(b11*(h(2)**2*(4*nx(1)*(11*p(1) + 29*p(2) &
    - 40*p(4) + 4*p(5) - 4*p(6)) + 8*nx(3)*(3*p(1) + 7*p(2) &
    - 10*p(4) + 2*p(5) - 2*p(6)) + nx(2)*(-5*p(1) - 11*p(2) &
    + 16*p(4) - 4*p(5) + 4*p(6))) + h(3)**2*(4*nx(3)*(-p(1) &
    + p(2) - 4*p(5) + 4*p(6)) + 2*nx(1)*(p(1) + p(2) - 2*(p(4) &
    - p(5) + p(6))) + nx(2)*(-5*p(1) + p(2) + 4*(p(4) - 4*p(5) &
    + 4*p(6)))) + 2*h(2)*h(3)*(nx(1)*(5*p(1) + 11*p(2) &
    - 4*(4*p(4) - p(5) + p(6))) - 2*(-2*nx(3)*(p(1) + 3*p(2) &
    - 4*p(4)) + nx(2)*(p(1) + p(2) - 2*(p(4) - p(5) + p(6)))))) &
    + b12*(h(2)**2*(4*nx(1)*(11*p(1) - 7*p(3) - 40*p(4) &
    + 40*p(5) - 4*p(6)) + 8*nx(3)*(3*p(1) - p(3) - 2*(5*p(4) &
    - 5*p(5) + p(6))) + nx(2)*(-5*p(1) + p(3) + 4*(4*p(4) &
    - 4*p(5) + p(6)))) + h(3)**2*(-4*nx(3)*(p(1) + 3*p(3) &
    - 4*p(6)) + 2*nx(1)*(p(1) + p(3) - 2*(p(4) - p(5) &
    + p(6))) + nx(2)*(-5*p(1) - 11*p(3) + 4*(p(4) - p(5) &
    + 4*p(6)))) + 2*h(2)*h(3)*(nx(1)*(5*p(1) - p(3) &
    - 4*(4*p(4) - 4*p(5) + p(6))) - 2*(2*nx(3)*(-p(1) &
    + p(3) + 4*p(4) - 4*p(5)) + nx(2)*(p(1) + p(3) &
    - 2*(p(4) - p(5) + p(6)))))))

  tfp(3)=(1d0/420d0)*(b12*(h(3)**2*(4*(nx(2)*(11*p(1) + 29*p(3) &
    - 4*p(4) + 4*p(5) - 40*p(6)) + 2*nx(3)*(3*p(1) + 7*p(3) &
    - 2*p(4) + 2*p(5) - 10*p(6))) + nx(1)*(-5*p(1) - 11*p(3) &
    + 4*p(4) - 4*p(5) + 16*p(6))) + 2*h(2)*h(3)*(4*nx(3)*(p(1) &
    + 3*p(3) - 4*p(6)) - 2*nx(1)*(p(1) + p(3) - 2*(p(4) &
    - p(5) + p(6))) + nx(2)*(5*p(1) + 11*p(3) - 4*(p(4) &
    - p(5) + 4*p(6)))) + h(2)**2*(nx(1)*(-5*p(1) + p(3) &
    + 4*(4*p(4) - 4*p(5) + p(6))) + 2*(2*nx(3)*(-p(1) + p(3) &
    + 4*p(4) - 4*p(5)) + nx(2)*(p(1) + p(3) - 2*(p(4) &
    - p(5) + p(6)))))) - b11*(2*h(2)*h(3)*(4*nx(3)*(-p(1) &
    + p(2) - 4*p(5) + 4*p(6)) + 2*nx(1)*(p(1) + p(2) &
    - 2*(p(4) - p(5) + p(6))) + nx(2)*(-5*p(1) + p(2) &
    + 4*(p(4) - 4*p(5) + 4*p(6)))) + h(2)**2*(nx(1)*(5*p(1) &
    + 11*p(2) - 4*(4*p(4) - p(5) + p(6))) - 2*(-2*nx(3)*(p(1) &
    + 3*p(2) - 4*p(4)) + nx(2)*(p(1) + p(2) - 2*(p(4) - p(5) &
    + p(6))))) + h(3)**2*(nx(1)*(5*p(1) - p(2) - 4*(p(4) &
    - 4*p(5) + 4*p(6))) - 4*(nx(2)*(11*p(1) - 7*p(2) - 4*p(4) &
    + 40*p(5) - 40*p(6)) + 2*nx(3)*(3*p(1) - p(2) - 2*(p(4) &
    - 5*p(5) + 5*p(6)))))))
  
  tfp(5)=(1d0/105d0)*(b12*(h(3)**2*(2*(nx(2)*(3*p(1) + 7*p(3) &
    - 2*p(4) + 2*p(5) - 10*p(6)) + 4*nx(3)*(2*p(1) + 3*p(3) &
    - 3*p(4) + 3*p(5) - 5*p(6))) - nx(1)*(p(1) + 3*p(3) &
    - 4*p(6))) + 2*h(2)*h(3)*(nx(1)*(p(1) - p(3) - 4*p(4) &
    + 4*p(5)) + nx(2)*(p(1) + 3*p(3) - 4*p(6)) &
    + 12*nx(3)*(p(1) + p(3) - 2*(p(4) - p(5) + p(6)))) &
    + h(2)**2*(nx(2)*(-p(1) + p(3) + 4*p(4) - 4*p(5)) &
    + 8*nx(3)*(2*p(1) + p(3) - 5*p(4) + 5*p(5) - 3*p(6)) &
    + nx(1)*(6*p(1) - 2*(p(3) + 2*(5*p(4) - 5*p(5) + p(6)))))) &
    + b11*(h(2)**2*((-nx(2))*(p(1) + 3*p(2) - 4*p(4)) &
    + 8*nx(3)*(2*p(1) + 3*p(2) - 5*p(4) + 3*p(5) - 3*p(6)) &
    + 2*nx(1)*(3*p(1) + 7*p(2) - 10*p(4) + 2*p(5) - 2*p(6))) &
    + 2*h(2)*h(3)*(nx(1)*(p(1) + 3*p(2) - 4*p(4)) &
    + nx(2)*(p(1) - p(2) + 4*p(5) - 4*p(6)) + 12*nx(3)*(p(1) &
    + p(2) - 2*(p(4) - p(5) + p(6)))) &
    + h(3)**2*(8*nx(3)*(2*p(1) + p(2) - 3*p(4) + 5*p(5) &
    - 5*p(6)) + nx(1)*(-p(1) + p(2) - 4*p(5) + 4*p(6)) &
    + nx(2)*(6*p(1) - 2*(p(2) + 2*(p(4) - 5*p(5) + 5*p(6)))))))

  fp=fp+cnst(3)*tfp


  !! Fpt2
  tfp(2)=(1d0/420d0)*(b21*(h(2)**2*(4*nx(1)*(11*q(1) + 29*q(2) &
    - 40*q(4) + 4*q(5) - 4*q(6)) + 8*nx(3)*(3*q(1) + 7*q(2) &
    - 10*q(4) + 2*q(5) - 2*q(6)) + nx(2)*(-5*q(1) - 11*q(2) &
    + 16*q(4) - 4*q(5) + 4*q(6))) + h(3)**2*(4*nx(3)*(-q(1) &
    + q(2) - 4*q(5) + 4*q(6)) + 2*nx(1)*(q(1) + q(2) - 2*(q(4) &
    - q(5) + q(6))) + nx(2)*(-5*q(1) + q(2) + 4*(q(4) - 4*q(5) &
    + 4*q(6)))) + 2*h(2)*h(3)*(nx(1)*(5*q(1) + 11*q(2) &
    - 4*(4*q(4) - q(5) + q(6))) - 2*(-2*nx(3)*(q(1) + 3*q(2) &
    - 4*q(4)) + nx(2)*(q(1) + q(2) - 2*(q(4) - q(5) + q(6)))))) &
    + b22*(h(2)**2*(4*nx(1)*(11*q(1) - 7*q(3) - 40*q(4) &
    + 40*q(5) - 4*q(6)) + 8*nx(3)*(3*q(1) - q(3) - 2*(5*q(4) &
    - 5*q(5) + q(6))) + nx(2)*(-5*q(1) + q(3) + 4*(4*q(4) &
    - 4*q(5) + q(6)))) + h(3)**2*(-4*nx(3)*(q(1) + 3*q(3) &
    - 4*q(6)) + 2*nx(1)*(q(1) + q(3) - 2*(q(4) - q(5) &
    + q(6))) + nx(2)*(-5*q(1) - 11*q(3) + 4*(q(4) - q(5) &
    + 4*q(6)))) + 2*h(2)*h(3)*(nx(1)*(5*q(1) - q(3) &
    - 4*(4*q(4) - 4*q(5) + q(6))) - 2*(2*nx(3)*(-q(1) + q(3) &
    + 4*q(4) - 4*q(5)) + nx(2)*(q(1) + q(3) &
    - 2*(q(4) - q(5) + q(6)))))))

  tfp(3)=(1d0/420d0)*(b22*(h(3)**2*(4*(nx(2)*(11*q(1) + 29*q(3) &
    - 4*q(4) + 4*q(5) - 40*q(6)) + 2*nx(3)*(3*q(1) + 7*q(3) &
    - 2*q(4) + 2*q(5) - 10*q(6))) + nx(1)*(-5*q(1) - 11*q(3) &
    + 4*q(4) - 4*q(5) + 16*q(6))) + 2*h(2)*h(3)*(4*nx(3)*(q(1) &
    + 3*q(3) - 4*q(6)) - 2*nx(1)*(q(1) + q(3) - 2*(q(4) &
    - q(5) + q(6))) + nx(2)*(5*q(1) + 11*q(3) - 4*(q(4) &
    - q(5) + 4*q(6)))) + h(2)**2*(nx(1)*(-5*q(1) + q(3) &
    + 4*(4*q(4) - 4*q(5) + q(6))) + 2*(2*nx(3)*(-q(1) + q(3) &
    + 4*q(4) - 4*q(5)) + nx(2)*(q(1) + q(3) - 2*(q(4) - q(5) &
    + q(6)))))) - b21*(2*h(2)*h(3)*(4*nx(3)*(-q(1) + q(2) &
    - 4*q(5) + 4*q(6)) + 2*nx(1)*(q(1) + q(2) - 2*(q(4) &
    - q(5) + q(6))) + nx(2)*(-5*q(1) + q(2) + 4*(q(4) &
    - 4*q(5) + 4*q(6)))) + h(2)**2*(nx(1)*(5*q(1) + 11*q(2) &
    - 4*(4*q(4) - q(5) + q(6))) - 2*(-2*nx(3)*(q(1) + 3*q(2) &
    - 4*q(4)) + nx(2)*(q(1) + q(2) - 2*(q(4) - q(5) &
    + q(6))))) + h(3)**2*(nx(1)*(5*q(1) - q(2) - 4*(q(4) &
    - 4*q(5) + 4*q(6))) - 4*(nx(2)*(11*q(1) - 7*q(2) - 4*q(4) &
    + 40*q(5) - 40*q(6)) + 2*nx(3)*(3*q(1) - q(2) - 2*(q(4) &
    - 5*q(5) + 5*q(6)))))))

  tfp(5)=(1d0/105d0)*(b22*(h(3)**2*(2*(nx(2)*(3*q(1) + 7*q(3) &
    - 2*q(4) + 2*q(5) - 10*q(6)) + 4*nx(3)*(2*q(1) + 3*q(3) &
    - 3*q(4) + 3*q(5) - 5*q(6))) - nx(1)*(q(1) + 3*q(3) &
    - 4*q(6))) + 2*h(2)*h(3)*(nx(1)*(q(1) - q(3) - 4*q(4) &
    + 4*q(5)) + nx(2)*(q(1) + 3*q(3) - 4*q(6)) &
    + 12*nx(3)*(q(1) + q(3) - 2*(q(4) - q(5) + q(6)))) &
    + h(2)**2*(nx(2)*(-q(1) + q(3) + 4*q(4) - 4*q(5)) &
    + 8*nx(3)*(2*q(1) + q(3) - 5*q(4) + 5*q(5) - 3*q(6)) &
    + nx(1)*(6*q(1) - 2*(q(3) + 2*(5*q(4) - 5*q(5) + q(6)))))) &
    + b21*(h(2)**2*((-nx(2))*(q(1) + 3*q(2) - 4*q(4)) &
    + 8*nx(3)*(2*q(1) + 3*q(2) - 5*q(4) + 3*q(5) - 3*q(6)) &
    + 2*nx(1)*(3*q(1) + 7*q(2) - 10*q(4) + 2*q(5) - 2*q(6))) &
    + 2*h(2)*h(3)*(nx(1)*(q(1) + 3*q(2) - 4*q(4)) &
    + nx(2)*(q(1) - q(2) + 4*q(5) - 4*q(6)) + 12*nx(3)*(q(1) &
    + q(2) - 2*(q(4) - q(5) + q(6)))) &
    + h(3)**2*(8*nx(3)*(2*q(1) + q(2) - 3*q(4) + 5*q(5) &
    - 5*q(6)) + nx(1)*(-q(1) + q(2) - 4*q(5) + 4*q(6)) &
    + nx(2)*(6*q(1) - 2*(q(2) + 2*(q(4) - 5*q(5) + 5*q(6)))))))

  fp=fp+cnst(3)*tfp


  !! Fpt3
  tfp(2)=(1d0/420d0)*(2*h(2)*h(3)*(4*nx(3)*w(2) - nx(2)*(w(2) &
    + w(3)) + nx(1)*(4*w(2) + w(3))) &
    + h(2)**2*((-nx(2))*(4*w(2) + w(3)) + 4*nx(3)*(5*w(2) &
    + w(3)) + 4*nx(1)*(10*w(2) + w(3))) &
    + h(3)**2*(-4*nx(3)*w(3) + nx(1)*(w(2) + w(3)) &
    - nx(2)*(w(2) + 4*w(3))))

  tfp(3)=(1d0/420d0)*(2*h(2)*h(3)*(nx(2)*w(2) + 4*(nx(2) &
    + nx(3))*w(3) - nx(1)*(w(2) + w(3))) &
    + h(2)**2*(-4*nx(3)*w(2) + nx(2)*(w(2) + w(3)) &
    - nx(1)*(4*w(2) + w(3))) + h(3)**2*(4*(nx(2) &
    + nx(3))*w(2) + 20*(2*nx(2) + nx(3))*w(3) &
    - nx(1)*(w(2) + 4*w(3))))

  tfp(5)=(1d0/105d0)*(2*h(2)*h(3)*(nx(1)*w(2) + nx(2)*w(3) &
    + 6*nx(3)*(w(2) + w(3))) + h(2)**2*((-nx(2))*w(2) &
    + 10*nx(3)*w(2) + 6*nx(3)*w(3) + nx(1)*(5*w(2) + w(3))) &
    + h(3)**2*(6*nx(3)*w(2) - nx(1)*w(3) + 10*nx(3)*w(3) &
    + nx(2)*(w(2) + 5*w(3))))

  fp=fp+cnst(6)*tfp


  !! Fqt1
  tfq(2)=(1d0/420d0)*(b11*(h(2)**2*(4*ny(1)*(11*p(1) + 29*p(2) &
    - 40*p(4) + 4*p(5) - 4*p(6)) + 8*ny(3)*(3*p(1) + 7*p(2) &
    - 10*p(4) + 2*p(5) - 2*p(6)) + ny(2)*(-5*p(1) - 11*p(2) &
    + 16*p(4) - 4*p(5) + 4*p(6))) + h(3)**2*(4*ny(3)*(-p(1) &
    + p(2) - 4*p(5) + 4*p(6)) + 2*ny(1)*(p(1) + p(2) - 2*(p(4) &
    - p(5) + p(6))) + ny(2)*(-5*p(1) + p(2) + 4*(p(4) - 4*p(5) &
    + 4*p(6)))) + 2*h(2)*h(3)*(ny(1)*(5*p(1) + 11*p(2) &
    - 4*(4*p(4) - p(5) + p(6))) - 2*(-2*ny(3)*(p(1) + 3*p(2) &
    - 4*p(4)) + ny(2)*(p(1) + p(2) - 2*(p(4) - p(5) + p(6)))))) &
    + b12*(h(2)**2*(4*ny(1)*(11*p(1) - 7*p(3) - 40*p(4) &
    + 40*p(5) - 4*p(6)) + 8*ny(3)*(3*p(1) - p(3) - 2*(5*p(4) &
    - 5*p(5) + p(6))) + ny(2)*(-5*p(1) + p(3) + 4*(4*p(4) &
    - 4*p(5) + p(6)))) + h(3)**2*(-4*ny(3)*(p(1) + 3*p(3) &
    - 4*p(6)) + 2*ny(1)*(p(1) + p(3) - 2*(p(4) - p(5) &
    + p(6))) + ny(2)*(-5*p(1) - 11*p(3) + 4*(p(4) - p(5) &
    + 4*p(6)))) + 2*h(2)*h(3)*(ny(1)*(5*p(1) - p(3) &
    - 4*(4*p(4) - 4*p(5) + p(6))) - 2*(2*ny(3)*(-p(1) &
    + p(3) + 4*p(4) - 4*p(5)) + ny(2)*(p(1) + p(3) &
    - 2*(p(4) - p(5) + p(6)))))))

  tfq(3)=(1d0/420d0)*(b12*(h(3)**2*(4*(ny(2)*(11*p(1) + 29*p(3) &
    - 4*p(4) + 4*p(5) - 40*p(6)) + 2*ny(3)*(3*p(1) + 7*p(3) &
    - 2*p(4) + 2*p(5) - 10*p(6))) + ny(1)*(-5*p(1) - 11*p(3) &
    + 4*p(4) - 4*p(5) + 16*p(6))) + 2*h(2)*h(3)*(4*ny(3)*(p(1) &
    + 3*p(3) - 4*p(6)) - 2*ny(1)*(p(1) + p(3) - 2*(p(4) &
    - p(5) + p(6))) + ny(2)*(5*p(1) + 11*p(3) - 4*(p(4) &
    - p(5) + 4*p(6)))) + h(2)**2*(ny(1)*(-5*p(1) + p(3) &
    + 4*(4*p(4) - 4*p(5) + p(6))) + 2*(2*ny(3)*(-p(1) + p(3) &
    + 4*p(4) - 4*p(5)) + ny(2)*(p(1) + p(3) - 2*(p(4) &
    - p(5) + p(6)))))) - b11*(2*h(2)*h(3)*(4*ny(3)*(-p(1) &
    + p(2) - 4*p(5) + 4*p(6)) + 2*ny(1)*(p(1) + p(2) &
    - 2*(p(4) - p(5) + p(6))) + ny(2)*(-5*p(1) + p(2) &
    + 4*(p(4) - 4*p(5) + 4*p(6)))) + h(2)**2*(ny(1)*(5*p(1) &
    + 11*p(2) - 4*(4*p(4) - p(5) + p(6))) - 2*(-2*ny(3)*(p(1) &
    + 3*p(2) - 4*p(4)) + ny(2)*(p(1) + p(2) - 2*(p(4) - p(5) &
    + p(6))))) + h(3)**2*(ny(1)*(5*p(1) - p(2) - 4*(p(4) &
    - 4*p(5) + 4*p(6))) - 4*(ny(2)*(11*p(1) - 7*p(2) - 4*p(4) &
    + 40*p(5) - 40*p(6)) + 2*ny(3)*(3*p(1) - p(2) - 2*(p(4) &
    - 5*p(5) + 5*p(6)))))))
  
  tfq(5)=(1d0/105d0)*(b12*(h(3)**2*(2*(ny(2)*(3*p(1) + 7*p(3) &
    - 2*p(4) + 2*p(5) - 10*p(6)) + 4*ny(3)*(2*p(1) + 3*p(3) &
    - 3*p(4) + 3*p(5) - 5*p(6))) - ny(1)*(p(1) + 3*p(3) &
    - 4*p(6))) + 2*h(2)*h(3)*(ny(1)*(p(1) - p(3) - 4*p(4) &
    + 4*p(5)) + ny(2)*(p(1) + 3*p(3) - 4*p(6)) &
    + 12*ny(3)*(p(1) + p(3) - 2*(p(4) - p(5) + p(6)))) &
    + h(2)**2*(ny(2)*(-p(1) + p(3) + 4*p(4) - 4*p(5)) &
    + 8*ny(3)*(2*p(1) + p(3) - 5*p(4) + 5*p(5) - 3*p(6)) &
    + ny(1)*(6*p(1) - 2*(p(3) + 2*(5*p(4) - 5*p(5) + p(6)))))) &
    + b11*(h(2)**2*((-ny(2))*(p(1) + 3*p(2) - 4*p(4)) &
    + 8*ny(3)*(2*p(1) + 3*p(2) - 5*p(4) + 3*p(5) - 3*p(6)) &
    + 2*ny(1)*(3*p(1) + 7*p(2) - 10*p(4) + 2*p(5) - 2*p(6))) &
    + 2*h(2)*h(3)*(ny(1)*(p(1) + 3*p(2) - 4*p(4)) &
    + ny(2)*(p(1) - p(2) + 4*p(5) - 4*p(6)) + 12*ny(3)*(p(1) &
    + p(2) - 2*(p(4) - p(5) + p(6)))) &
    + h(3)**2*(8*ny(3)*(2*p(1) + p(2) - 3*p(4) + 5*p(5) &
    - 5*p(6)) + ny(1)*(-p(1) + p(2) - 4*p(5) + 4*p(6)) &
    + ny(2)*(6*p(1) - 2*(p(2) + 2*(p(4) - 5*p(5) + 5*p(6)))))))

  fq=fq+cnst(3)*tfq


  !! Fqt2
  tfq(2)=(1d0/420d0)*(b21*(h(2)**2*(4*ny(1)*(11*q(1) + 29*q(2) &
    - 40*q(4) + 4*q(5) - 4*q(6)) + 8*ny(3)*(3*q(1) + 7*q(2) &
    - 10*q(4) + 2*q(5) - 2*q(6)) + ny(2)*(-5*q(1) - 11*q(2) &
    + 16*q(4) - 4*q(5) + 4*q(6))) + h(3)**2*(4*ny(3)*(-q(1) &
    + q(2) - 4*q(5) + 4*q(6)) + 2*ny(1)*(q(1) + q(2) - 2*(q(4) &
    - q(5) + q(6))) + ny(2)*(-5*q(1) + q(2) + 4*(q(4) - 4*q(5) &
    + 4*q(6)))) + 2*h(2)*h(3)*(ny(1)*(5*q(1) + 11*q(2) &
    - 4*(4*q(4) - q(5) + q(6))) - 2*(-2*ny(3)*(q(1) + 3*q(2) &
    - 4*q(4)) + ny(2)*(q(1) + q(2) - 2*(q(4) - q(5) + q(6)))))) &
    + b22*(h(2)**2*(4*ny(1)*(11*q(1) - 7*q(3) - 40*q(4) &
    + 40*q(5) - 4*q(6)) + 8*ny(3)*(3*q(1) - q(3) - 2*(5*q(4) &
    - 5*q(5) + q(6))) + ny(2)*(-5*q(1) + q(3) + 4*(4*q(4) &
    - 4*q(5) + q(6)))) + h(3)**2*(-4*ny(3)*(q(1) + 3*q(3) &
    - 4*q(6)) + 2*ny(1)*(q(1) + q(3) - 2*(q(4) - q(5) &
    + q(6))) + ny(2)*(-5*q(1) - 11*q(3) + 4*(q(4) - q(5) &
    + 4*q(6)))) + 2*h(2)*h(3)*(ny(1)*(5*q(1) - q(3) &
    - 4*(4*q(4) - 4*q(5) + q(6))) - 2*(2*ny(3)*(-q(1) + q(3) &
    + 4*q(4) - 4*q(5)) + ny(2)*(q(1) + q(3) &
    - 2*(q(4) - q(5) + q(6)))))))

  tfq(3)=(1d0/420d0)*(b22*(h(3)**2*(4*(ny(2)*(11*q(1) + 29*q(3) &
    - 4*q(4) + 4*q(5) - 40*q(6)) + 2*ny(3)*(3*q(1) + 7*q(3) &
    - 2*q(4) + 2*q(5) - 10*q(6))) + ny(1)*(-5*q(1) - 11*q(3) &
    + 4*q(4) - 4*q(5) + 16*q(6))) + 2*h(2)*h(3)*(4*ny(3)*(q(1) &
    + 3*q(3) - 4*q(6)) - 2*ny(1)*(q(1) + q(3) - 2*(q(4) &
    - q(5) + q(6))) + ny(2)*(5*q(1) + 11*q(3) - 4*(q(4) &
    - q(5) + 4*q(6)))) + h(2)**2*(ny(1)*(-5*q(1) + q(3) &
    + 4*(4*q(4) - 4*q(5) + q(6))) + 2*(2*ny(3)*(-q(1) + q(3) &
    + 4*q(4) - 4*q(5)) + ny(2)*(q(1) + q(3) - 2*(q(4) - q(5) &
    + q(6)))))) - b21*(2*h(2)*h(3)*(4*ny(3)*(-q(1) + q(2) &
    - 4*q(5) + 4*q(6)) + 2*ny(1)*(q(1) + q(2) - 2*(q(4) &
    - q(5) + q(6))) + ny(2)*(-5*q(1) + q(2) + 4*(q(4) &
    - 4*q(5) + 4*q(6)))) + h(2)**2*(ny(1)*(5*q(1) + 11*q(2) &
    - 4*(4*q(4) - q(5) + q(6))) - 2*(-2*ny(3)*(q(1) + 3*q(2) &
    - 4*q(4)) + ny(2)*(q(1) + q(2) - 2*(q(4) - q(5) &
    + q(6))))) + h(3)**2*(ny(1)*(5*q(1) - q(2) - 4*(q(4) &
    - 4*q(5) + 4*q(6))) - 4*(ny(2)*(11*q(1) - 7*q(2) - 4*q(4) &
    + 40*q(5) - 40*q(6)) + 2*ny(3)*(3*q(1) - q(2) - 2*(q(4) &
    - 5*q(5) + 5*q(6)))))))

  tfq(5)=(1d0/105d0)*(b22*(h(3)**2*(2*(ny(2)*(3*q(1) + 7*q(3) &
    - 2*q(4) + 2*q(5) - 10*q(6)) + 4*ny(3)*(2*q(1) + 3*q(3) &
    - 3*q(4) + 3*q(5) - 5*q(6))) - ny(1)*(q(1) + 3*q(3) &
    - 4*q(6))) + 2*h(2)*h(3)*(ny(1)*(q(1) - q(3) - 4*q(4) &
    + 4*q(5)) + ny(2)*(q(1) + 3*q(3) - 4*q(6)) &
    + 12*ny(3)*(q(1) + q(3) - 2*(q(4) - q(5) + q(6)))) &
    + h(2)**2*(ny(2)*(-q(1) + q(3) + 4*q(4) - 4*q(5)) &
    + 8*ny(3)*(2*q(1) + q(3) - 5*q(4) + 5*q(5) - 3*q(6)) &
    + ny(1)*(6*q(1) - 2*(q(3) + 2*(5*q(4) - 5*q(5) + q(6)))))) &
    + b21*(h(2)**2*((-ny(2))*(q(1) + 3*q(2) - 4*q(4)) &
    + 8*ny(3)*(2*q(1) + 3*q(2) - 5*q(4) + 3*q(5) - 3*q(6)) &
    + 2*ny(1)*(3*q(1) + 7*q(2) - 10*q(4) + 2*q(5) - 2*q(6))) &
    + 2*h(2)*h(3)*(ny(1)*(q(1) + 3*q(2) - 4*q(4)) &
    + ny(2)*(q(1) - q(2) + 4*q(5) - 4*q(6)) + 12*ny(3)*(q(1) &
    + q(2) - 2*(q(4) - q(5) + q(6)))) &
    + h(3)**2*(8*ny(3)*(2*q(1) + q(2) - 3*q(4) + 5*q(5) &
    - 5*q(6)) + ny(1)*(-q(1) + q(2) - 4*q(5) + 4*q(6)) &
    + ny(2)*(6*q(1) - 2*(q(2) + 2*(q(4) - 5*q(5) + 5*q(6)))))))

  fq=fq+cnst(3)*tfq


  !! Fqt3
  tfq(2)=(1d0/420d0)*(2*h(2)*h(3)*(4*ny(3)*w(2) - ny(2)*(w(2) &
    + w(3)) + ny(1)*(4*w(2) + w(3))) &
    + h(2)**2*((-ny(2))*(4*w(2) + w(3)) + 4*ny(3)*(5*w(2) &
    + w(3)) + 4*ny(1)*(10*w(2) + w(3))) &
    + h(3)**2*(-4*ny(3)*w(3) + ny(1)*(w(2) + w(3)) &
    - ny(2)*(w(2) + 4*w(3))))

  tfq(3)=(1d0/420d0)*(2*h(2)*h(3)*(ny(2)*w(2) + 4*(ny(2) &
    + ny(3))*w(3) - ny(1)*(w(2) + w(3))) &
    + h(2)**2*(-4*ny(3)*w(2) + ny(2)*(w(2) + w(3)) &
    - ny(1)*(4*w(2) + w(3))) + h(3)**2*(4*(ny(2) &
    + ny(3))*w(2) + 20*(2*ny(2) + ny(3))*w(3) &
    - ny(1)*(w(2) + 4*w(3))))

  tfq(5)=(1d0/105d0)*(2*h(2)*h(3)*(ny(1)*w(2) + ny(2)*w(3) &
    + 6*ny(3)*(w(2) + w(3))) + h(2)**2*((-ny(2))*w(2) &
    + 10*ny(3)*w(2) + 6*ny(3)*w(3) + ny(1)*(5*w(2) + w(3))) &
    + h(3)**2*(6*ny(3)*w(2) - ny(1)*w(3) + 10*ny(3)*w(3) &
    + ny(2)*(w(2) + 5*w(3))))

  fq=fq+cnst(6)*tfq

end subroutine

subroutine boundaryCase31(fp,fq,fn,fw,nx,ny,p,q,w,&
  n,h,cnst,b11,b12,b21,b22)
implicit none
  
  integer(kind=4)::i,j,k

  real(kind=8),intent(in)::nx(3),ny(3),p(6),q(6),h(3)
  real(kind=8),intent(in)::w(3),n(3),cnst(10)
  real(kind=8),intent(in)::b11,b12,b21,b22
  real(kind=8),intent(out)::fp(6),fq(6),fn(3),fw(3)
  real(kind=8)::tfp(6),tfq(6)

  fp=0
  fq=0
  fn=0
  fw=0
  tfp=0
  tfq=0

  !! Fn
  ! fn(1)=-((nx(1)*p(1))/60) + (7*nx(2)*p(1))/60 + (nx(3)*p(1))/15 &
  !   + (nx(1)*p(3))/60 - (nx(2)*p(3))/60 + (nx(2)*p(6))/15 &
  !   + (4*nx(3)*p(6))/15 - (ny(1)*q(1))/60 + (7*ny(2)*q(1))/60 &
  !   + (ny(3)*q(1))/15 + (ny(1)*q(3))/60 - (ny(2)*q(3))/60 &
  !   + (ny(2)*q(6))/15 + (4*ny(3)*q(6))/15

  ! fn(3)=-((nx(1)*p(1))/60) + (nx(2)*p(1))/60 + (7*nx(1)*p(3))/60 &
  !   - (nx(2)*p(3))/60 + (nx(3)*p(3))/15 + (nx(1)*p(6))/15 &
  !   + (4*nx(3)*p(6))/15 - (ny(1)*q(1))/60 + (ny(2)*q(1))/60 &
  !   + (7*ny(1)*q(3))/60 - (ny(2)*q(3))/60 + (ny(3)*q(3))/15 &
  !   + (ny(1)*q(6))/15 + (4*ny(3)*q(6))/15

  ! fn=-fn


  !! Fw
  fw(1)=(1d0/60d0)*((b11*(n(1) - n(2)) + b12*(n(1) &
    - n(3)))*(h(1)*(nx(1) - 9*nx(2) - 12*nx(3)) - h(3)*(nx(1) &
    + nx(2) + 8*nx(3))) + (b21*(n(1) - n(2)) + b22*(n(1) &
    - n(3)))*(h(1)*(ny(1) - 9*ny(2) - 12*ny(3)) - h(3)*(ny(1) &
    + ny(2) + 8*ny(3))))

  fw(3)=(1d0/60d0)*((-(b11*(n(1) - n(2)) + b12*(n(1) &
    - n(3))))*(h(1)*(nx(1) + nx(2) + 8*nx(3)) + h(3)*(9*nx(1) &
    - nx(2) + 12*nx(3))) - (b21*(n(1) - n(2)) + b22*(n(1) &
    - n(3)))*(h(1)*(ny(1) + ny(2) + 8*ny(3)) + h(3)*(9*ny(1) &
    - ny(2) + 12*ny(3))))


  !! Fpt1
  tfp(1)=(1d0/420d0)*(b12*(h(1)**2*(-4*(nx(2)*(29*p(1) + 7*p(3) &
    - 36*p(6)) + 2*nx(3)*(7*p(1) + p(3) - 8*p(6))) &
    + nx(1)*(11*p(1) + p(3) - 12*p(6))) &
    - h(3)**2*(2*(nx(2)*(p(1) - p(3)) + 2*nx(3)*(p(1) + 3*p(3) &
    - 4*p(6))) + nx(1)*(p(1) + 11*p(3) - 12*p(6))) &
    - 2*h(1)*h(3)*(-2*nx(1)*(p(1) - p(3)) + nx(2)*(11*p(1) &
    + p(3) - 12*p(6)) + 4*nx(3)*(3*p(1) + p(3) - 4*p(6)))) &
    + b11*((-h(3)**2)*(2*(nx(2)*(p(1) + p(2) - 2*(p(4) + p(5) &
    - p(6))) + 2*nx(3)*(p(1) - p(2) + 4*p(5) - 4*p(6))) &
    + nx(1)*(p(1) - 5*p(2) + 4*(p(4) + 4*p(5) - 4*p(6)))) &
    + 2*h(1)*h(3)*(-4*nx(3)*(3*p(1) + p(2) - 4*p(4)) &
    + 2*nx(1)*(p(1) + p(2) - 2*(p(4) + p(5) - p(6))) &
    + nx(2)*(-11*p(1) - 5*p(2) + 4*(4*p(4) + p(5) - p(6)))) &
    + h(1)**2*(nx(1)*(11*p(1) + 5*p(2) - 16*p(4) - 4*p(5) &
    + 4*p(6)) - 4*(2*nx(3)*(7*p(1) + 3*p(2) - 10*p(4) - 2*p(5) &
    + 2*p(6)) + nx(2)*(29*p(1) + 11*p(2) - 40*p(4) - 4*p(5) &
    + 4*p(6)))))) 

  tfp(3)=(1d0/420d0)*(b11*(2*h(1)*h(3)*(2*(nx(2)*(p(1) + p(2) &
    - 2*(p(4) + p(5) - p(6))) + 2*nx(3)*(p(1) - p(2) + 4*p(5) &
    - 4*p(6))) + nx(1)*(p(1) - 5*p(2) + 4*(p(4) + 4*p(5) &
    - 4*p(6)))) + h(1)**2*(4*nx(3)*(3*p(1) + p(2) - 4*p(4)) &
    - 2*nx(1)*(p(1) + p(2) - 2*(p(4) + p(5) - p(6))) &
    + nx(2)*(11*p(1) + 5*p(2) - 4*(4*p(4) + p(5) - p(6)))) &
    + h(3)**2*(8*nx(3)*(p(1) - 3*p(2) + 2*(p(4) + 5*p(5) &
    - 5*p(6))) - nx(2)*(p(1) - 5*p(2) + 4*(p(4) + 4*p(5) &
    - 4*p(6))) + 4*nx(1)*(7*p(1) - 11*p(2) + 4*p(4) &
    + 40*p(5) - 40*p(6)))) + b12*(2*h(1)*h(3)*(2*(nx(2)*(p(1) &
    - p(3)) + 2*nx(3)*(p(1) + 3*p(3) - 4*p(6))) + nx(1)*(p(1) &
    + 11*p(3) - 12*p(6))) + h(3)**2*(4*nx(1)*(7*p(1) + 29*p(3) &
    - 36*p(6)) - nx(2)*(p(1) + 11*p(3) - 12*p(6)) &
    + 8*nx(3)*(p(1) + 7*p(3) - 8*p(6))) &
    + h(1)**2*(-2*nx(1)*(p(1) - p(3)) + nx(2)*(11*p(1) + p(3) &
    - 12*p(6)) + 4*nx(3)*(3*p(1) + p(3) - 4*p(6)))))

  tfp(6)=(1d0/105d0)*(b12*(h(1)**2*(-2*(nx(2)*(7*p(1) + p(3) &
    - 8*p(6)) + 4*nx(3)*(3*p(1) - p(3) - 2*p(6))) &
    + nx(1)*(3*p(1) + p(3) - 4*p(6))) &
    + 2*h(1)*h(3)*(12*nx(3)*(-p(1) + p(3)) - nx(2)*(3*p(1) &
    + p(3) - 4*p(6)) + nx(1)*(p(1) + 3*p(3) - 4*p(6))) &
    + h(3)**2*(2*nx(1)*(p(1) + 7*p(3) - 8*p(6)) - nx(2)*(p(1) &
    + 3*p(3) - 4*p(6)) - 8*nx(3)*(p(1) - 3*p(3) + 2*p(6)))) &
    + b11*(-2*h(1)*h(3)*(nx(2)*(3*p(1) + p(2) - 4*p(4)) &
    + 12*nx(3)*(p(1) + p(2) - 2*(p(4) + p(5) - p(6))) &
    + nx(1)*(-p(1) + p(2) - 4*p(5) + 4*p(6))) &
    + h(3)**2*(2*nx(1)*(p(1) - 3*p(2) + 2*(p(4) + 5*p(5) &
    - 5*p(6))) + nx(2)*(-p(1) + p(2) - 4*p(5) + 4*p(6)) &
    - 8*nx(3)*(p(1) + 2*p(2) - 3*p(4) - 5*p(5) + 5*p(6))) &
    + h(1)**2*(nx(1)*(3*p(1) + p(2) - 4*p(4)) &
    - 2*(nx(2)*(7*p(1) + 3*p(2) - 10*p(4) - 2*p(5) + 2*p(6)) &
    + 4*nx(3)*(3*p(1) + 2*p(2) - 5*p(4) - 3*p(5) + 3*p(6))))))

  fp=fp+cnst(3)*tfp

  !! Fpt2
  tfp(1)=(1d0/420d0)*(b22*(h(1)**2*(-4*(nx(2)*(29*q(1) &
    + 7*q(3) - 36*q(6)) + 2*nx(3)*(7*q(1) + q(3) - 8*q(6))) &
    + nx(1)*(11*q(1) + q(3) - 12*q(6))) &
    - h(3)**2*(2*(nx(2)*(q(1) - q(3)) + 2*nx(3)*(q(1) &
    + 3*q(3) - 4*q(6))) + nx(1)*(q(1) + 11*q(3) - 12*q(6))) &
    - 2*h(1)*h(3)*(-2*nx(1)*(q(1) - q(3)) + nx(2)*(11*q(1) &
    + q(3) - 12*q(6)) + 4*nx(3)*(3*q(1) + q(3) - 4*q(6)))) &
    + b21*((-h(3)**2)*(2*(nx(2)*(q(1) + q(2) - 2*(q(4) + q(5) &
    - q(6))) + 2*nx(3)*(q(1) - q(2) + 4*q(5) - 4*q(6))) &
    + nx(1)*(q(1) - 5*q(2) + 4*(q(4) + 4*q(5) - 4*q(6)))) &
    + 2*h(1)*h(3)*(-4*nx(3)*(3*q(1) + q(2) - 4*q(4)) &
    + 2*nx(1)*(q(1) + q(2) - 2*(q(4) + q(5) - q(6))) &
    + nx(2)*(-11*q(1) - 5*q(2) + 4*(4*q(4) + q(5) - q(6)))) &
    + h(1)**2*(nx(1)*(11*q(1) + 5*q(2) - 16*q(4) &
    - 4*q(5) + 4*q(6)) - 4*(2*nx(3)*(7*q(1) + 3*q(2) &
    - 10*q(4) - 2*q(5) + 2*q(6)) + nx(2)*(29*q(1) + 11*q(2) &
    - 40*q(4) - 4*q(5) + 4*q(6)))))) 

  tfp(3)=(1d0/420d0)*(b21*(2*h(1)*h(3)*(2*(nx(2)*(q(1) &
    + q(2) - 2*(q(4) + q(5) - q(6))) + 2*nx(3)*(q(1) &
    - q(2) + 4*q(5) - 4*q(6))) + nx(1)*(q(1) - 5*q(2) &
    + 4*(q(4) + 4*q(5) - 4*q(6)))) + h(1)**2*(4*nx(3)*(3*q(1) &
    + q(2) - 4*q(4)) - 2*nx(1)*(q(1) + q(2) - 2*(q(4) + q(5) &
    - q(6))) + nx(2)*(11*q(1) + 5*q(2) - 4*(4*q(4) + q(5) &
    - q(6)))) + h(3)**2*(8*nx(3)*(q(1) - 3*q(2) + 2*(q(4) &
    + 5*q(5) - 5*q(6))) - nx(2)*(q(1) - 5*q(2) + 4*(q(4) &
    + 4*q(5) - 4*q(6))) + 4*nx(1)*(7*q(1) - 11*q(2) + 4*q(4) &
    + 40*q(5) - 40*q(6)))) + b22*(2*h(1)*h(3)*(2*(nx(2)*(q(1) &
    - q(3)) + 2*nx(3)*(q(1) + 3*q(3) - 4*q(6))) + nx(1)*(q(1) &
    + 11*q(3) - 12*q(6))) + h(3)**2*(4*nx(1)*(7*q(1) &
    + 29*q(3) - 36*q(6)) - nx(2)*(q(1) + 11*q(3) &
    - 12*q(6)) + 8*nx(3)*(q(1) + 7*q(3) - 8*q(6))) &
    + h(1)**2*(-2*nx(1)*(q(1) - q(3)) + nx(2)*(11*q(1) &
    + q(3) - 12*q(6)) + 4*nx(3)*(3*q(1) + q(3) - 4*q(6)))))

  tfp(6)=(1d0/105d0)*(b22*(h(1)**2*(-2*(nx(2)*(7*q(1) &
    + q(3) - 8*q(6)) + 4*nx(3)*(3*q(1) - q(3) - 2*q(6))) &
    + nx(1)*(3*q(1) + q(3) - 4*q(6))) &
    + 2*h(1)*h(3)*(12*nx(3)*(-q(1) + q(3)) - nx(2)*(3*q(1) &
    + q(3) - 4*q(6)) + nx(1)*(q(1) + 3*q(3) - 4*q(6))) &
    + h(3)**2*(2*nx(1)*(q(1) + 7*q(3) - 8*q(6)) - nx(2)*(q(1) &
    + 3*q(3) - 4*q(6)) - 8*nx(3)*(q(1) - 3*q(3) + 2*q(6)))) &
    + b21*(-2*h(1)*h(3)*(nx(2)*(3*q(1) + q(2) - 4*q(4)) &
    + 12*nx(3)*(q(1) + q(2) - 2*(q(4) + q(5) - q(6))) &
    + nx(1)*(-q(1) + q(2) - 4*q(5) + 4*q(6))) &
    + h(3)**2*(2*nx(1)*(q(1) - 3*q(2) + 2*(q(4) + 5*q(5) &
    - 5*q(6))) + nx(2)*(-q(1) + q(2) - 4*q(5) + 4*q(6)) &
    - 8*nx(3)*(q(1) + 2*q(2) - 3*q(4) - 5*q(5) + 5*q(6))) &
    + h(1)**2*(nx(1)*(3*q(1) + q(2) - 4*q(4)) &
    - 2*(nx(2)*(7*q(1) + 3*q(2) - 10*q(4) - 2*q(5) + 2*q(6)) &
    + 4*nx(3)*(3*q(1) + 2*q(2) - 5*q(4) - 3*q(5) + 3*q(6))))))

  fp=fp+cnst(3)*tfp

  !! Fpt3
  tfp(1)=(1d0/420d0)*(2*h(1)*h(3)*(4*(nx(2) + nx(3))*w(1) &
    + nx(2)*w(3) - nx(1)*(w(1) + w(3))) &
    + h(1)**2*(20*(2*nx(2) + nx(3))*w(1) + 4*(nx(2) &
    + nx(3))*w(3) - nx(1)*(4*w(1) + w(3))) &
    + h(3)**2*(-4*nx(3)*w(3) + nx(2)*(w(1) + w(3)) &
    - nx(1)*(w(1) + 4*w(3))))

  tfp(3)=(1d0/420d0)*(h(1)**2*(-4*nx(3)*w(1) + nx(1)*(w(1) &
    + w(3)) - nx(2)*(4*w(1) + w(3))) &
    + 2*h(1)*h(3)*(4*nx(3)*w(3) - nx(2)*(w(1) + w(3)) &
    + nx(1)*(w(1) + 4*w(3))) + h(3)**2*((-nx(2))*(w(1) &
    + 4*w(3)) + 4*nx(3)*(w(1) + 5*w(3)) &
    + 4*nx(1)*(w(1) + 10*w(3))))

  tfp(6)=(1d0/105d0)*(h(1)**2*((-nx(1))*w(1) + 5*nx(2)*w(1) &
    + 10*nx(3)*w(1) + nx(2)*w(3) + 6*nx(3)*w(3)) &
    + 2*h(1)*h(3)*(nx(2)*w(1) + nx(1)*w(3) + 6*nx(3)*(w(1) &
    + w(3))) + h(3)**2*(6*nx(3)*w(1) - nx(2)*w(3) &
    + 10*nx(3)*w(3) + nx(1)*(w(1) + 5*w(3))))

  fp=fp+cnst(6)*tfp


  !! Fqt1
  tfq(1)=(1d0/420d0)*(b12*(h(1)**2*(-4*(ny(2)*(29*p(1) + 7*p(3) &
    - 36*p(6)) + 2*ny(3)*(7*p(1) + p(3) - 8*p(6))) &
    + ny(1)*(11*p(1) + p(3) - 12*p(6))) &
    - h(3)**2*(2*(ny(2)*(p(1) - p(3)) + 2*ny(3)*(p(1) + 3*p(3) &
    - 4*p(6))) + ny(1)*(p(1) + 11*p(3) - 12*p(6))) &
    - 2*h(1)*h(3)*(-2*ny(1)*(p(1) - p(3)) + ny(2)*(11*p(1) &
    + p(3) - 12*p(6)) + 4*ny(3)*(3*p(1) + p(3) - 4*p(6)))) &
    + b11*((-h(3)**2)*(2*(ny(2)*(p(1) + p(2) - 2*(p(4) + p(5) &
    - p(6))) + 2*ny(3)*(p(1) - p(2) + 4*p(5) - 4*p(6))) &
    + ny(1)*(p(1) - 5*p(2) + 4*(p(4) + 4*p(5) - 4*p(6)))) &
    + 2*h(1)*h(3)*(-4*ny(3)*(3*p(1) + p(2) - 4*p(4)) &
    + 2*ny(1)*(p(1) + p(2) - 2*(p(4) + p(5) - p(6))) &
    + ny(2)*(-11*p(1) - 5*p(2) + 4*(4*p(4) + p(5) - p(6)))) &
    + h(1)**2*(ny(1)*(11*p(1) + 5*p(2) - 16*p(4) - 4*p(5) &
    + 4*p(6)) - 4*(2*ny(3)*(7*p(1) + 3*p(2) - 10*p(4) - 2*p(5) &
    + 2*p(6)) + ny(2)*(29*p(1) + 11*p(2) - 40*p(4) - 4*p(5) &
    + 4*p(6)))))) 

  tfq(3)=(1d0/420d0)*(b11*(2*h(1)*h(3)*(2*(ny(2)*(p(1) + p(2) &
    - 2*(p(4) + p(5) - p(6))) + 2*ny(3)*(p(1) - p(2) + 4*p(5) &
    - 4*p(6))) + ny(1)*(p(1) - 5*p(2) + 4*(p(4) + 4*p(5) &
    - 4*p(6)))) + h(1)**2*(4*ny(3)*(3*p(1) + p(2) - 4*p(4)) &
    - 2*ny(1)*(p(1) + p(2) - 2*(p(4) + p(5) - p(6))) &
    + ny(2)*(11*p(1) + 5*p(2) - 4*(4*p(4) + p(5) - p(6)))) &
    + h(3)**2*(8*ny(3)*(p(1) - 3*p(2) + 2*(p(4) + 5*p(5) &
    - 5*p(6))) - ny(2)*(p(1) - 5*p(2) + 4*(p(4) + 4*p(5) &
    - 4*p(6))) + 4*ny(1)*(7*p(1) - 11*p(2) + 4*p(4) &
    + 40*p(5) - 40*p(6)))) + b12*(2*h(1)*h(3)*(2*(ny(2)*(p(1) &
    - p(3)) + 2*ny(3)*(p(1) + 3*p(3) - 4*p(6))) + ny(1)*(p(1) &
    + 11*p(3) - 12*p(6))) + h(3)**2*(4*ny(1)*(7*p(1) + 29*p(3) &
    - 36*p(6)) - ny(2)*(p(1) + 11*p(3) - 12*p(6)) &
    + 8*ny(3)*(p(1) + 7*p(3) - 8*p(6))) &
    + h(1)**2*(-2*ny(1)*(p(1) - p(3)) + ny(2)*(11*p(1) + p(3) &
    - 12*p(6)) + 4*ny(3)*(3*p(1) + p(3) - 4*p(6)))))

  tfq(6)=(1d0/105d0)*(b12*(h(1)**2*(-2*(ny(2)*(7*p(1) + p(3) &
    - 8*p(6)) + 4*ny(3)*(3*p(1) - p(3) - 2*p(6))) &
    + ny(1)*(3*p(1) + p(3) - 4*p(6))) &
    + 2*h(1)*h(3)*(12*ny(3)*(-p(1) + p(3)) - ny(2)*(3*p(1) &
    + p(3) - 4*p(6)) + ny(1)*(p(1) + 3*p(3) - 4*p(6))) &
    + h(3)**2*(2*ny(1)*(p(1) + 7*p(3) - 8*p(6)) - ny(2)*(p(1) &
    + 3*p(3) - 4*p(6)) - 8*ny(3)*(p(1) - 3*p(3) + 2*p(6)))) &
    + b11*(-2*h(1)*h(3)*(ny(2)*(3*p(1) + p(2) - 4*p(4)) &
    + 12*ny(3)*(p(1) + p(2) - 2*(p(4) + p(5) - p(6))) &
    + ny(1)*(-p(1) + p(2) - 4*p(5) + 4*p(6))) &
    + h(3)**2*(2*ny(1)*(p(1) - 3*p(2) + 2*(p(4) + 5*p(5) &
    - 5*p(6))) + ny(2)*(-p(1) + p(2) - 4*p(5) + 4*p(6)) &
    - 8*ny(3)*(p(1) + 2*p(2) - 3*p(4) - 5*p(5) + 5*p(6))) &
    + h(1)**2*(ny(1)*(3*p(1) + p(2) - 4*p(4)) &
    - 2*(ny(2)*(7*p(1) + 3*p(2) - 10*p(4) - 2*p(5) + 2*p(6)) &
    + 4*ny(3)*(3*p(1) + 2*p(2) - 5*p(4) - 3*p(5) + 3*p(6))))))

  fq=fq+cnst(3)*tfq

  !! Fqt2
  tfq(1)=(1d0/420d0)*(b22*(h(1)**2*(-4*(ny(2)*(29*q(1) &
    + 7*q(3) - 36*q(6)) + 2*ny(3)*(7*q(1) + q(3) - 8*q(6))) &
    + ny(1)*(11*q(1) + q(3) - 12*q(6))) &
    - h(3)**2*(2*(ny(2)*(q(1) - q(3)) + 2*ny(3)*(q(1) &
    + 3*q(3) - 4*q(6))) + ny(1)*(q(1) + 11*q(3) - 12*q(6))) &
    - 2*h(1)*h(3)*(-2*ny(1)*(q(1) - q(3)) + ny(2)*(11*q(1) &
    + q(3) - 12*q(6)) + 4*ny(3)*(3*q(1) + q(3) - 4*q(6)))) &
    + b21*((-h(3)**2)*(2*(ny(2)*(q(1) + q(2) - 2*(q(4) + q(5) &
    - q(6))) + 2*ny(3)*(q(1) - q(2) + 4*q(5) - 4*q(6))) &
    + ny(1)*(q(1) - 5*q(2) + 4*(q(4) + 4*q(5) - 4*q(6)))) &
    + 2*h(1)*h(3)*(-4*ny(3)*(3*q(1) + q(2) - 4*q(4)) &
    + 2*ny(1)*(q(1) + q(2) - 2*(q(4) + q(5) - q(6))) &
    + ny(2)*(-11*q(1) - 5*q(2) + 4*(4*q(4) + q(5) - q(6)))) &
    + h(1)**2*(ny(1)*(11*q(1) + 5*q(2) - 16*q(4) &
    - 4*q(5) + 4*q(6)) - 4*(2*ny(3)*(7*q(1) + 3*q(2) &
    - 10*q(4) - 2*q(5) + 2*q(6)) + ny(2)*(29*q(1) + 11*q(2) &
    - 40*q(4) - 4*q(5) + 4*q(6)))))) 

  tfq(3)=(1d0/420d0)*(b21*(2*h(1)*h(3)*(2*(ny(2)*(q(1) &
    + q(2) - 2*(q(4) + q(5) - q(6))) + 2*ny(3)*(q(1) &
    - q(2) + 4*q(5) - 4*q(6))) + ny(1)*(q(1) - 5*q(2) &
    + 4*(q(4) + 4*q(5) - 4*q(6)))) + h(1)**2*(4*ny(3)*(3*q(1) &
    + q(2) - 4*q(4)) - 2*ny(1)*(q(1) + q(2) - 2*(q(4) + q(5) &
    - q(6))) + ny(2)*(11*q(1) + 5*q(2) - 4*(4*q(4) + q(5) &
    - q(6)))) + h(3)**2*(8*ny(3)*(q(1) - 3*q(2) + 2*(q(4) &
    + 5*q(5) - 5*q(6))) - ny(2)*(q(1) - 5*q(2) + 4*(q(4) &
    + 4*q(5) - 4*q(6))) + 4*ny(1)*(7*q(1) - 11*q(2) + 4*q(4) &
    + 40*q(5) - 40*q(6)))) + b22*(2*h(1)*h(3)*(2*(ny(2)*(q(1) &
    - q(3)) + 2*ny(3)*(q(1) + 3*q(3) - 4*q(6))) + ny(1)*(q(1) &
    + 11*q(3) - 12*q(6))) + h(3)**2*(4*ny(1)*(7*q(1) &
    + 29*q(3) - 36*q(6)) - ny(2)*(q(1) + 11*q(3) &
    - 12*q(6)) + 8*ny(3)*(q(1) + 7*q(3) - 8*q(6))) &
    + h(1)**2*(-2*ny(1)*(q(1) - q(3)) + ny(2)*(11*q(1) &
    + q(3) - 12*q(6)) + 4*ny(3)*(3*q(1) + q(3) - 4*q(6)))))

  tfq(6)=(1d0/105d0)*(b22*(h(1)**2*(-2*(ny(2)*(7*q(1) &
    + q(3) - 8*q(6)) + 4*ny(3)*(3*q(1) - q(3) - 2*q(6))) &
    + ny(1)*(3*q(1) + q(3) - 4*q(6))) &
    + 2*h(1)*h(3)*(12*ny(3)*(-q(1) + q(3)) - ny(2)*(3*q(1) &
    + q(3) - 4*q(6)) + ny(1)*(q(1) + 3*q(3) - 4*q(6))) &
    + h(3)**2*(2*ny(1)*(q(1) + 7*q(3) - 8*q(6)) - ny(2)*(q(1) &
    + 3*q(3) - 4*q(6)) - 8*ny(3)*(q(1) - 3*q(3) + 2*q(6)))) &
    + b21*(-2*h(1)*h(3)*(ny(2)*(3*q(1) + q(2) - 4*q(4)) &
    + 12*ny(3)*(q(1) + q(2) - 2*(q(4) + q(5) - q(6))) &
    + ny(1)*(-q(1) + q(2) - 4*q(5) + 4*q(6))) &
    + h(3)**2*(2*ny(1)*(q(1) - 3*q(2) + 2*(q(4) + 5*q(5) &
    - 5*q(6))) + ny(2)*(-q(1) + q(2) - 4*q(5) + 4*q(6)) &
    - 8*ny(3)*(q(1) + 2*q(2) - 3*q(4) - 5*q(5) + 5*q(6))) &
    + h(1)**2*(ny(1)*(3*q(1) + q(2) - 4*q(4)) &
    - 2*(ny(2)*(7*q(1) + 3*q(2) - 10*q(4) - 2*q(5) + 2*q(6)) &
    + 4*ny(3)*(3*q(1) + 2*q(2) - 5*q(4) - 3*q(5) + 3*q(6))))))

  fq=fq+cnst(3)*tfq

  !! Fqt3
  tfq(1)=(1d0/420d0)*(2*h(1)*h(3)*(4*(ny(2) + ny(3))*w(1) &
    + ny(2)*w(3) - ny(1)*(w(1) + w(3))) &
    + h(1)**2*(20*(2*ny(2) + ny(3))*w(1) + 4*(ny(2) &
    + ny(3))*w(3) - ny(1)*(4*w(1) + w(3))) &
    + h(3)**2*(-4*ny(3)*w(3) + ny(2)*(w(1) + w(3)) &
    - ny(1)*(w(1) + 4*w(3))))

  tfq(3)=(1d0/420d0)*(h(1)**2*(-4*ny(3)*w(1) + ny(1)*(w(1) &
    + w(3)) - ny(2)*(4*w(1) + w(3))) &
    + 2*h(1)*h(3)*(4*ny(3)*w(3) &
    - ny(2)*(w(1) + w(3)) + ny(1)*(w(1) + 4*w(3))) &
    + h(3)**2*((-ny(2))*(w(1) + 4*w(3)) + 4*ny(3)*(w(1) &
    + 5*w(3)) + 4*ny(1)*(w(1) + 10*w(3))))

  tfq(6)=(1d0/105d0)*(h(1)**2*((-ny(1))*w(1) + 5*ny(2)*w(1) &
    + 10*ny(3)*w(1) + ny(2)*w(3) + 6*ny(3)*w(3)) &
    + 2*h(1)*h(3)*(ny(2)*w(1) + ny(1)*w(3) + 6*ny(3)*(w(1) &
    + w(3))) + h(3)**2*(6*ny(3)*w(1) - ny(2)*w(3) &
    + 10*ny(3)*w(3) + ny(1)*(w(1) + 5*w(3))))

  fq=fq+cnst(6)*tfq

end subroutine